<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/>

<title>Webinar: Monitoring Kubernetes and Cloud Native Apps</title>

<!-- https://gauger.io/fonticon/ -->
<link rel="icon" href="images/camera.ico"/>

<link rel="stylesheet" href="media/reveal.js@4.3.1/dist/reveal.css"/>
<link rel="stylesheet" href="media/reveal.js@4.3.1/dist/theme/black.css" id="theme"/>
<link rel="stylesheet" href="themes/theme2022.css" id="theme"/>
<link rel="stylesheet" href="themes/common.css"/>
<link rel="stylesheet" href="media/highlight.js@11.5.0/styles/rainbow.css"/>
<link rel="stylesheet" href="media/fontawesome-pro@6.2.0/css/all.min.css"/>
<link rel="stylesheet" href="media/notyf@3.10.0/notyf.min.css"/>
</head>

<body>
<div class="reveal">
<div class="slides">

<section data-markdown="" data-separator="^---$" data-separator-vertical="^--$"><textarea data-template="">
<!-- .slide: data-background="images/tobias-tullius-Q2-EQDwxFtw-unsplash.jpg" class="vertical-center" style="padding: 1em 1em 1em 1em; color: white; background: rgba(0, 0, 0, 0.5); width: 90%; margin: auto;" -->

# Monitoring Kubernetes and Cloud Native Apps

Nicholas Dille, Haufe.Group

<i class="fa-brands fa-docker" style="width: 1.5em; text-align: center;"></i> Docker Captain

<i class="fa-brands fa-windows" style="width: 1.5em; text-align: center;"></i> Microsoft MVP

<i class="fa-brands fa-twitter" style="width: 1.5em; text-align: center;"></i> @nicholasdille
    </textarea></section>

    <section data-markdown="000_introduction/02_bio.md" data-separator="^---$" data-separator-vertical="^--$"></section>

    <section data-markdown="" data-separator="^---$" data-separator-vertical="^--$"><textarea data-template="">
## Agenda

| From  | To    | What           |
|-------|-------|----------------|
| 09:00 |       | Let's roll     |
| 10:45 | 11:00 | Coffee Break   |
| 11:00 | 12:30 | Let's continue |
| 12:30 | 13:00 | Q&amp;A        |
|       | 13:00 | The End        |
    </textarea></section>

    <section data-markdown="" data-separator="^---$" data-separator-vertical="^--$"><textarea data-template="">
Agenda
- https://www.datadoghq.com/blog/how-to-collect-and-graph-kubernetes-metrics/
- o11y
  - Three pillars: Metrics, Logs, Tracing
  - Focus on metrics
- Push vs. pull
- Telegraf/InfluxDB for push
- Exporters/Prometheus for pull

Container metrics
- Docker / cgroups
- `docker stats`
- `systemd-cgtop`
- `/sys/fs/cgroup/cpuacct/docker/6f52a04ac483b7b40d738c4916b1783808a73b32054b8b17ae2bc83845a445ac/cpuacct.usage`
- `/sys/fs/cgroup/memory/docker/6f52a04ac483b7b40d738c4916b1783808a73b32054b8b17ae2bc83845a445ac/memory.usage_in_bytes`
- `kubectl top` requires metrics server https://github.com/kubernetes-sigs/metrics-server/
- kubeletctl:

    ```bash
    IP="$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' kind-worker)"
    TOKEN="$(kubectl get secrets kubelet -o json | jq --raw-output '.data.token' | base64 -d)"
    kubectl get secrets kubelet -o json | jq --raw-output '.data."ca.crt"' | base64 -d >ca.crt
    kubeletctl --server ${IP} --cacert ca.crt --token ${TOKEN} metrics cadvisor | less
    ```

- `curl` against kubelet:

    ```bash
    IP="$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' kind-worker)"
    TOKEN="$(kubectl get secrets kubelet -o json | jq --raw-output '.data.token' | base64 -d)"
    kubectl get secrets kubelet -o json | jq --raw-output '.data."ca.crt"' | base64 -d >ca.crt
    curl -skH "Authorization: Bearer ${TOKEN}" "https://${IP}:10250/metrics/cadvisor" | less
    curl -skH "Authorization: Bearer ${TOKEN}" "https://${IP}:10250/metrics/cadvisor" | grep container_memory_usage_bytes | grep kube-proxy
    ```

Host metrics
- OS/k8s reservations (managed k8s?)
  - https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/
  - CPU: 6% of first core, 1% of second core, 0.5% of third and fourth core, 0.25% per core > 4
  - Memory AWS: 255MiB + 11MiB * MAX_PODS
  - Memory others: 255MiB, 25% of 4GiB, 20% of next 4GiB, 10% of next 8GiB, 6% of next 112GiB, 2% of memory above 128GiB
  - https://learnk8s.io/kubernetes-instance-calculator
  - https://github.com/learnk8s/kubernetes-resource-inspector
- node_exporter

Cluster metrics
- metrics-server https://github.com/kubernetes-sigs/metrics-server/
  - Collected metrics
  - Required for Horizontal/Vertical Pod AutoScaler
  - TODO: Explore
- kube-state-metrics https://github.com/kubernetes/kube-state-metrics
  - New metrics about cluster
  - TODO: Explore

Anatomy of metrics (endpoints)
- HTTP(S) server with(out) authentication
- Comment precedes metric with type and description
- Metrics should container tags and a value
- Time series through regular pull

Collection
- Prometheus
- Exporter
- blackbox-exporter
- Scrape configuration
  - Read from app with metrics endpoints
  - Read from central exporter which reads from app
  - Read from app with exporter sidecar
- Push gateway
  - Helps with firewall traversal
  - Accepts metrics from apps or agents
  - Does not remove orphaned metrics
  - No data?
  - https://github.com/prometheus/pushgateway#command-line
- Prometheus Operator
- ServiceMonitor / PodMonitor
- https://github.com/kubernetes-monitoring/kubernetes-mixin
- Blackbox Exporter
  - https://github.com/prometheus/blackbox_exporter
  - https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-blackbox-exporter
- JSON Exporter
  - https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-json-exporter

Visualization
- Grafana
- Datasource
- PromQL
  - Graph for memory
  - Graph for CPU (usage)
  - Count running containers

promtool https://github.com/prometheus/prometheus/tree/main/cmd/promtool

PromQL https://prometheus.io/docs/prometheus/latest/querying/basics/

PromQL CLI https://github.com/nalbury/promql-cli

Pod QoS https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/

Outlook
- Aggregation of multiple clusters ([Federation](https://prometheus.io/docs/prometheus/latest/federation/))
- Scaling
  - [Thanos](https://thanos.io/)
  - [Cortex](https://cortexmetrics.io/)
  - [Mimir](https://github.com/grafana/mimir)
- Log shipping (ElasticSearch, promtail/loki)
- Tracing (Tempo etc.)

Alternative
- [kube-prometheus](https://github.com/prometheus-operator/kube-prometheus)
- [prometheus-adapter](https://github.com/kubernetes-sigs/prometheus-adapter)
    </textarea></section>

    <section data-markdown="" data-separator="^---$" data-separator-vertical="^--$"><textarea data-template="">
## Summary

<ul class="fa-ul">
<li><span class="fa-li"><i class="fa-solid fa-infinity"></i></span> GitLab covers the whole DevOps process</li>
<li><span class="fa-li"><i class="fa-solid fa-ball-pile"></i></span> GitLab is packed with features</li>
<li><span class="fa-li"><i class="fa-solid fa-gauge-min"></i></span> No plugins to support recurring tasks</li>
<li><span class="fa-li"><i class="fa-solid fa-shield-check"></i></span> Useful security features even in free tier</li>
<li><span class="fa-li"><i class="fa-solid fa-shield-check"></i></span> Useful security features even in free tier</li>

### Upcoming talks / other content

2022-11-10 [Sicherheit im Kubernetes-Cluster](https://webinare.heise.de/kubernetes/security-im-kubernetes-cluster/)

Video-Kurs [Container-Orchestrierung mit Kubernetes leicht gemacht](https://shop.heise-academy.de/kubernetes-container-orchestrierung-leicht-gemacht)
</ul>
</textarea></section>

</div>
</div>

<script src="media/reveal.js@4.3.1/dist/reveal.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/markdown/markdown.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/highlight/highlight.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/search/search.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/zoom/zoom.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/notes/notes.js" type="application/javascript"></script>
<script src="media/clipboard@2.0.11/dist/clipboard.js" type="application/javascript"></script>
<script src="media/notyf@3.10.0/notyf.min.js" type="application/javascript"></script>
<script>
var durationInMinutes = 4 * 60;
Reveal.initialize({
    width: 1920,
    height: 1080,
    margin: 0.05,
    minScale: 0.2,
    maxScale: 2.0,
    controlsTutorial: false,
    showSlideNumber: false,
    hash: true,
    history: true,
    keyboard: true,
    overview: true,
    center: false,
    touch: false,
    shuffle: false,
    fragments: true,
    fragmentInURL: true,
    embedded: false,
    help: true,
    showNotes: false,
    autoPlayMedia: null,
    mouseWheel: false,
    previewLinks: false,
    transition: 'convex',
    transitionSpeed: 'default',
    backgroundTransition: 'fade',
    hideInactiveCursor: true,
    hideCursorTime: 3000,

    totalTime: durationInMinutes * 60,
    allottedTime: durationInMinutes * 60 * 1000,

    barColor: 'rgb(200, 0, 0)',
    pausedBarColor: 'rgba(200, 0, 0, .6)',

    markdown: {
        smartypants: true
    },

    keyboard: {
        // pause/resume time when Enter is pressed
        13: () => {
            ElapsedTimeBar.isPaused ? ElapsedTimeBar.resume() : ElapsedTimeBar.pause();
        },
        // reset timer when 'r' is pressed
        82: () => {
            ElapsedTimeBar.reset();
        }
    },

    dependencies: [
        { src: 'media/plugins/elapsed-time-bar@18feb15/elapsed-time-bar.js' }
    ],

    plugins: [
        RevealMarkdown,
        RevealHighlight,
        RevealSearch,
        RevealZoom,
        RevealNotes
    ]
});

var clipboard = new ClipboardJS(".hljs", {
    text: function(trigger) {
        return trigger.innerText;
    }
});
var notyf = new Notyf({
    types: [
        {
            type: 'success',
            className: 'notyf-toast-success'
        }
    ]
});
clipboard.on("success", function(e) {
    notyf.success("Copied to clipboard :)");
});
clipboard.on("error", function(e) {
    notyf.error("Can't copy to clipboard :(");
});
</script>

</body>
</html>
