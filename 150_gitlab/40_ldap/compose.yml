# https://docs.docker.com/compose/compose-file

volumes:
  openldap_data:
  phpldapadmin_nginx_config:
  phpldapadmin_config:
  phpldapadmin_htdocs:

services:

  # https://hub.docker.com/r/bitnami/openldap
  openldap:
    image: bitnami/openldap:2.6.1
    environment:
      LDAP_ADMIN_USERNAME: admin
      LDAP_ADMIN_PASSWORD: adminpassword
      LDAP_USERS: user01,user02
      LDAP_PASSWORDS: password1,password2
    volumes:
    - openldap_data:/bitnami/openldap

  # https://github.com/kalaksi/docker-phpldapadmin
  # http://phpldapadmin.sourceforge.net/wiki/index.php/Main_Page
  phpldapadmin:
    image: phpldapadmin:1.2.3
    build:
      context: github.com/kalaksi/docker-phpldapadmin
      dockerfile: Dockerfile
      args:
        PHPLDAPADMIN_VERSION: 1.2.3
    volumes:
    - phpldapadmin_htdocs:/usr/share/phpldapadmin/htdocs
    - phpldapadmin_config:/etc/phpldapadmin
    - phpldapadmin_nginx_config:/etc/nginx/conf.d

  # https://github.com/kalaksi/docker-phpldapadmin
  web:
    image: nginx:stable
    depends_on:
    - phpldapadmin
    volumes:
      - phpldapadmin_nginx_config:/etc/nginx/conf.d:ro
      - phpldapadmin_htdocs:/usr/share/phpldapadmin/htdocs:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 5m
      timeout: 10s
      retries: 1
      start_period: 10s
    labels:
      traefik.enable: "true"
      traefik.http.services.pla.loadbalancer.server.port: 8080
      traefik.http.routers.pla.entrypoints: http
      traefik.http.routers.pla.rule: HostRegexp(`pla.{domain:.+}`)
